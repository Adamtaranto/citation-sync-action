name: CI - Validate Action

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-yaml:
    name: Validate action.yml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check action.yml syntax
        run: |
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "✓ action.yml is valid YAML"
      
      - name: Verify required fields
        run: |
          # Check for required action metadata
          for field in name description author runs; do
            if ! grep -q "^${field}:" action.yml; then
              echo "ERROR: Missing required field: ${field}"
              exit 1
            fi
          done
          echo "✓ All required fields present"
      
      - name: Validate inputs and outputs
        run: |
          # Validate that all referenced step IDs exist in the action
          python3 << 'EOF'
          import yaml
          import re
          
          with open('action.yml') as f:
              action = yaml.safe_load(f)
          
          # Get output step references
          outputs = action.get('outputs', {})
          referenced_steps = set()
          
          for output_name, output_config in outputs.items():
              value = output_config.get('value', '')
              # Extract step IDs from steps.STEP_ID.outputs.something expressions
              matches = re.findall(r'steps\.([a-zA-Z0-9_-]+)\.outputs', value)
              referenced_steps.update(matches)
          
          print(f"✓ Found {len(referenced_steps)} step references in outputs")
          print(f"  Referenced steps: {', '.join(sorted(referenced_steps))}")
          
          # Check that steps exist in the composite action
          steps = action['runs']['steps']
          step_ids = {step.get('id') for step in steps if 'id' in step}
          
          print(f"✓ Found {len(step_ids)} steps with IDs")
          print(f"  Step IDs: {', '.join(sorted(filter(None, step_ids)))}")
          
          # Verify all referenced steps exist
          missing = referenced_steps - step_ids
          if missing:
              print(f"ERROR: Referenced steps not found: {', '.join(missing)}")
              exit(1)
          
          print("✓ All referenced steps exist")
          EOF
  
  lint-markdown:
    name: Lint Markdown files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check markdown files exist
        run: |
          # Check root-level markdown files
          for file in README.md CHANGELOG.md; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing $file"
              exit 1
            fi
          done
          
          # Check .github/ directory markdown files
          for file in CONTRIBUTING.md CODE_OF_CONDUCT.md SECURITY.md; do
            if [ ! -f ".github/$file" ]; then
              echo "ERROR: Missing .github/$file"
              exit 1
            fi
          done
          
          echo "✓ All required markdown files present"
  
  check-shell-syntax:
    name: Check shell script syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Extract and validate shell scripts from action.yml
        run: |
          # Extract shell scripts from action.yml for validation
          # This is a basic check - full testing would require actual workflow runs
          python3 << 'EOF'
          import yaml
          import subprocess
          import tempfile
          import os
          
          with open('action.yml') as f:
              action = yaml.safe_load(f)
          
          steps = action['runs']['steps']
          errors = []
          
          for i, step in enumerate(steps):
              if 'run' in step and step.get('shell') == 'bash':
                  script = step['run']
                  step_name = step.get('name', f'Step {i+1}')
                  
                  # Write script to temp file
                  with tempfile.NamedTemporaryFile(mode='w', suffix='.sh', delete=False) as f:
                      # Add bash shebang
                      f.write('#!/bin/bash\n')
                      f.write('set -euo pipefail\n')
                      # Replace GitHub Actions expression syntax with bash variable syntax
                      script_clean = script.replace('$' + '{{' + ' ', '$' + '{')
                      script_clean = script_clean.replace(' ' + '}}', '}')
                      f.write(script_clean)
                      temp_file = f.name
                  
                  try:
                      # Check syntax with bash -n
                      result = subprocess.run(
                          ['bash', '-n', temp_file],
                          capture_output=True,
                          text=True
                      )
                      
                      if result.returncode != 0:
                          errors.append(f"{step_name}: {result.stderr}")
                      else:
                          print(f"✓ {step_name}: syntax OK")
                  finally:
                      os.unlink(temp_file)
          
          if errors:
              print("\nERROR: Syntax errors found:")
              for error in errors:
                  print(f"  - {error}")
              exit(1)
          else:
              print(f"\n✓ All {len(steps)} shell scripts have valid syntax")
          EOF
  
  test-action-structure:
    name: Test action structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify action can be loaded
        run: |
          # Check that action.yml is in the right location
          if [ ! -f "action.yml" ] && [ ! -f "action.yaml" ]; then
            echo "ERROR: action.yml or action.yaml must be in repository root"
            exit 1
          fi
          echo "✓ Action metadata file found in correct location"
      
      - name: Check branding
        run: |
          python3 << 'EOF'
          import yaml
          
          with open('action.yml') as f:
              action = yaml.safe_load(f)
          
          branding = action.get('branding', {})
          
          if not branding:
              print("WARNING: No branding defined")
              exit(0)
          
          # Check valid icon and color
          icon = branding.get('icon')
          color = branding.get('color')
          
          if icon:
              print(f"✓ Branding icon: {icon}")
          if color:
              print(f"✓ Branding color: {color}")
          
          print("✓ Branding configuration valid")
          EOF
  
  validate-license:
    name: Validate LICENSE
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check LICENSE file
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "ERROR: LICENSE file not found"
            exit 1
          fi
          
          # Check it's MIT license
          if grep -q "MIT License" LICENSE; then
            echo "✓ LICENSE file present (MIT)"
          else
            echo "WARNING: LICENSE may not be MIT"
          fi
